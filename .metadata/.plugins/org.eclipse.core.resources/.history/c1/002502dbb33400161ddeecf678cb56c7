package controle;

import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;

import javax.swing.JOptionPane;

import controle.CtrlElaborarProva.Status;
import dominio.Aluno;
import dominio.DAO;
import dominio.DadosException;
import dominio.IDAOSerializavel;
import dominio.Professor;
import face.JanelaElaborarProva;
import face.JanelaPrincipalAluno;
import face.JanelaPrincipalProfessor;

/**
 * Este é o controlador que gerencia a execução do meu programa.
 * 
 * @author Alessandro Cerqueira
 */
public class CtrlPrograma {
	//
	// ATRIBUTOS
	// ---------
	// O controlador do programa deve ter um atributo para
	// cada controlador de caso de uso do programa.
	//
	// Também o controlador do programa deve ter um atributo
	// para referenciar a janela principal do programa.
	//

	/**
	 * Referência para o controlador do caso de uso Iniciar Prova
	 */
	private CtrlIniciarProva ctrlIniciarProva;

	/**
	 * Referência para o controlador do caso de uso Elaborar Prova
	 */
	private CtrlElaborarProva ctrlElaborarProva;

	/**
	 * Referência para o controlador do caso de uso Elaborar Questão
	 */
	private CtrlElaborarQuestao ctrlElaborarQuestao;

	/**
	 * Referência para o controlador do caso de uso Login
	 */
	private CtrlLogin ctrlLogin;

	/**
	 * Referência para o controlador do caso de uso Corrigir Prova
	 */
	private CtrlCorrigirProva ctrlCorrigirProva;

	/**
	 * Referência para o controlador do caso de uso Consultar Prova do Aluno
	 */
	private CtrlConsultarProvaAluno ctrlConsultarProvaAluno;

	/**
	 * Referência para a janela principal do programa
	 */
	private JanelaPrincipalProfessor jPrincipalProfessor;
	private JanelaPrincipalAluno jPrincipalAluno;

	//
	// MÉTODOS
	//

	/**
	 * Construtor do CtrlPrograma
	 */
	public CtrlPrograma() {
	}

	public void iniciar() throws ControleException, DadosException {
		// Recupera os DAOs do sistema
		IDAOSerializavel daoProfessor = (IDAOSerializavel) DAO.getDAO(Professor.class);
		IDAOSerializavel daoAluno = (IDAOSerializavel) DAO.getDAO(Aluno.class);

		//
		// Recuperação dos objetos serializados no arquivo c:/dados.dat
		//
		try {
			// Abrindo o arquivo para leitura binária
			FileInputStream fis = new FileInputStream("dados.dat");
			ObjectInputStream ois = new ObjectInputStream(fis);
			// Solicitação para os DAOs gerenciarem os objetos recuperados do
			// arquivo
			daoProfessor.recuperarObjetos(ois);
			daoAluno.recuperarObjetos(ois);
			// Fechando o arquivo
			ois.close();
		} catch (FileNotFoundException e) {
			System.out.println("Arquivo dados.dat não encontrado");
		} catch (IOException e) {
			e.printStackTrace();
		} catch (ClassNotFoundException e) {
			e.printStackTrace();
		}
		this.iniciarCasoDeUsoEfetuarLogin();
	}

	public void terminar() {
		// Recuperando os DAOs do sistema
		IDAOSerializavel daoProfessor = (IDAOSerializavel) DAO.getDAO(Professor.class);
		IDAOSerializavel daoAluno = (IDAOSerializavel) DAO.getDAO(Aluno.class);

		try {
			// Abrindo o arquivo c:/dados.dat para escrita
			FileOutputStream fos = new FileOutputStream("dados.dat");
			ObjectOutputStream oos = new ObjectOutputStream(fos);
			// Salvando os objetos gerenciados pelos DAOs
			daoProfessor.salvarObjetos(oos);
			daoAluno.salvarObjetos(oos);
			// Fechando e salvando o arquivo
			oos.close();
		} catch (IOException e) {
			e.printStackTrace();
		}
		// Método estático da classe System que encerra o programa
		System.exit(0);
	}

	//
	// CASO DE USO - EfetuarLogin
	//

	public void iniciarCasoDeUsoEfetuarLogin() throws ControleException, DadosException {
		this.ctrlLogin = new CtrlLogin(this);
	}

	public void loginProfessorEfetuado(Professor usr) throws ControleException, DadosException {
		this.ctrlLogin.terminar();
		this.ctrlLogin = null;
		this.jPrincipalProfessor = new JanelaPrincipalProfessor(this);
	}

	public void loginAlunoEfetuado(Aluno usr) throws ControleException, DadosException {
		this.ctrlLogin.terminar();
		this.ctrlLogin = null;
		this.jPrincipalAluno = new JanelaPrincipalAluno(this);
	}

	public void erroFatalLogin() throws ControleException, DadosException {
		JOptionPane.showMessageDialog(null, "Login Abortado!");
		this.ctrlLogin.terminar();
		this.ctrlLogin = null;
		this.terminar();
	}

	//
	// CASO DE USO - IniciarProva
	//
	public void iniciarCasoDeUsoCtrlIniciarProva() throws ControleException, DadosException {
		// Instanciando os controladores de caso de uso do sistema
		this.ctrlIniciarProva = new CtrlIniciarProva(this);
	}

	public void terminarCasoDeUsoCtrlIniciarProva() throws ControleException {
		this.ctrlIniciarProva.terminar();
		this.ctrlIniciarProva = null;
	}

	//
	// CASO DE USO - ElaborarProva
	//
	public void iniciarCasoDeUsoCtrlElaborarProva() throws ControleException, DadosException {
		// Instanciando os controladores de caso de uso do sistema
		this.ctrlElaborarProva = new CtrlElaborarProva(this);
	}

	public void terminarCasoDeUsoCtrlElaborarProva() throws ControleException {
		this.ctrlElaborarProva.terminar();
		this.ctrlElaborarProva = null;
	}

	//
	// CASO DE USO - ElaborarQuestão
	//

	public void iniciarCasoDeUsoCtrlElaborarQuestao() throws ControleException, DadosException {
		// Instanciando os controladores de caso de uso do sistema
		this.ctrlElaborarQuestao = new CtrlElaborarQuestao(this);
	}

	public void terminarCasoDeUsoCtrlElaborarQuestao() throws ControleException {
		this.ctrlElaborarQuestao.terminar();
		this.ctrlElaborarQuestao = null;
	}

	//
	// CASO DE USO - Corrigir Prova
	//

	public void iniciarCasoDeUsoCtrlCorrigirProva() throws ControleException, DadosException {
		// Instanciando os controladores de caso de uso do sistema
		this.ctrlCorrigirProva = new CtrlCorrigirProva(this);
	}

	public void terminarCasoDeUsoCtrlCorrigirProva() throws ControleException {
		this.ctrlCorrigirProva.terminar();
		this.ctrlCorrigirProva = null;
	}

	//
	// CASO DE USO - Consultar Prova do Aluno
	//

	public void iniciarCasoDeUsoCtrlConsultarProvaAluno() throws ControleException, DadosException {
		// Instanciando os controladores de caso de uso do sistema
		this.ctrlConsultarProvaAluno = new CtrlConsultarProvaAluno(this);
	}

	public void terminarCasoDeUsoCtrlConsultarProvaAluno() throws ControleException {
		this.ctrlConsultarProvaAluno.terminar();
		this.ctrlConsultarProvaAluno = null;
	}

	public static void main(String[] args) throws ControleException, DadosException {
		CtrlPrograma prg = new CtrlPrograma();
		prg.iniciar();
	}

}
